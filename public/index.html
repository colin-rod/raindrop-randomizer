<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Random Raindrop Reader</title>
  <style>
    body { font-family: sans-serif; padding: 20px; max-width: 900px; margin: auto; }
    select, button { padding: 10px; margin: 10px 5px; }
    #bookmark { 
      margin-top: 20px; 
      padding: 20px; 
      border: 1px solid #ccc; 
      border-radius: 8px;
      min-height: 400px;
      background: #f9f9f9;
    }
    #bookmark h3 { 
      margin-top: 0; 
      color: #333;
      font-size: 24px;
      line-height: 1.3;
    }
    #bookmark p { 
      font-size: 16px; 
      line-height: 1.6; 
      color: #666;
      margin: 15px 0;
    }
    #bookmark a { 
      display: inline-block;
      padding: 10px 20px;
      background: #007bff;
      color: white;
      text-decoration: none;
      border-radius: 5px;
      margin-top: 15px;
    }
    #bookmark a:hover { 
      background: #0056b3; 
    }
    .bookmark-content {
      max-height: 300px;
      overflow-y: auto;
      padding-right: 10px;
    }
  </style>
</head>
<body>
  <h1>ðŸ“š Random Raindrop</h1>
  
  <label for="collections">Choose a collection:</label>
  <select id="collections">
    <option value="0">All Collections</option>
  </select>
  
  <button id="get">Get Random</button>
  <button id="delete" disabled>Delete</button>

  <div id="bookmark"></div>

  <script>
    let current = null;
    let selectedCollection = null;

    // Load collections on startup
    async function loadCollections() {
      try {
        const res = await fetch("/api/getCollections");
        if (!res.ok) {
          throw new Error(`HTTP error! status: ${res.status}`);
        }
        const collections = await res.json();
        const sel = document.getElementById("collections");
        collections.forEach(c => {
          const opt = document.createElement("option");
          opt.value = c.id;
          opt.textContent = c.title;
          sel.appendChild(opt);
        });
        selectedCollection = sel.value || "0";
        sel.addEventListener("change", e => selectedCollection = e.target.value);
      } catch (error) {
        console.error("Failed to load collections:", error);
        document.getElementById("bookmark").innerHTML = `<p>Error loading collections: ${error.message}</p>`;
      }
    }

    async function getRandom() {
      if (!selectedCollection) return;
      try {
        const res = await fetch(`/api/getRandom?collectionId=${selectedCollection}`);
        if (!res.ok) {
          throw new Error(`HTTP error! status: ${res.status}`);
        }
        const data = await res.json();
        if (data.error) {
          document.getElementById("bookmark").innerHTML = `<p>${data.error}</p>`;
          return;
        }
        current = data;
        document.getElementById("bookmark").innerHTML = `
          <h3>${data.title}</h3>
          <div class="bookmark-content">
            <p>${data.excerpt || "No description available"}</p>
            ${data.note ? `<p><strong>Note:</strong> ${data.note}</p>` : ""}
            ${data.tags && data.tags.length > 0 ? `<p><strong>Tags:</strong> ${data.tags.join(", ")}</p>` : ""}
          </div>
          <a href="${data.link}" target="_blank">Read Original</a>
        `;
        document.getElementById("delete").disabled = false;
      } catch (error) {
        console.error("Failed to get random bookmark:", error);
        document.getElementById("bookmark").innerHTML = `<p>Error getting random bookmark: ${error.message}</p>`;
      }
    }

    async function deleteBookmark() {
      if (!current) return;
      try {
        const res = await fetch(`/api/delete?id=${current._id}`);
        if (!res.ok) {
          throw new Error(`HTTP error! status: ${res.status}`);
        }
        const data = await res.json();
        if (data.success) {
          document.getElementById("bookmark").innerHTML = "<p>âœ… Deleted! Getting new random bookmark...</p>";
          document.getElementById("delete").disabled = true;
          current = null;
          // Automatically get a new random bookmark
          setTimeout(() => getRandom(), 1000);
        }
      } catch (error) {
        console.error("Failed to delete bookmark:", error);
        document.getElementById("bookmark").innerHTML = `<p>Error deleting bookmark: ${error.message}</p>`;
      }
    }

    document.getElementById("get").addEventListener("click", getRandom);
    document.getElementById("delete").addEventListener("click", deleteBookmark);

    loadCollections();
  </script>
</body>
</html>